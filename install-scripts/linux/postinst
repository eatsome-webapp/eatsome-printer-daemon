#!/bin/bash
#
# Debian/Ubuntu (.deb) Postinstall Script
# Runs after package installation to configure system for printer daemon
#
# This script:
# 1. Creates udev rules for USB printer access
# 2. Adds current user to lp group
# 3. Installs systemd user service
# 4. Enables and starts the service
#

set -e

# Package name
PACKAGE_NAME="eatsome-printer-service"

# Installation paths
INSTALL_DIR="/opt/eatsome-printer-service"
SERVICE_FILE="/usr/lib/systemd/user/eatsome-printer.service"
UDEV_RULES="/etc/udev/rules.d/60-eatsome-printer.rules"

# ============================================================================
# 1. Create udev Rules for USB Printer Access
# ============================================================================

echo "ğŸ“ Creating udev rules for USB printer access..."

cat > "$UDEV_RULES" <<'EOF'
# Eatsome Printer Service - USB Printer Access Rules
# Grants lp group access to USB thermal printers

# Epson Printers
SUBSYSTEM=="usb", ATTRS{idVendor}=="04b8", MODE="0666", GROUP="lp"

# Star Micronics Printers
SUBSYSTEM=="usb", ATTRS{idVendor}=="0519", MODE="0666", GROUP="lp"

# Brother Printers
SUBSYSTEM=="usb", ATTRS{idVendor}=="04f9", MODE="0666", GROUP="lp"

# Citizen Printers
SUBSYSTEM=="usb", ATTRS{idVendor}=="1d90", MODE="0666", GROUP="lp"

# Generic USB Printers (Class 7 = Printer)
SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", ATTRS{bDeviceClass}=="07", MODE="0666", GROUP="lp"
EOF

chmod 644 "$UDEV_RULES"
echo "âœ… udev rules created at $UDEV_RULES"

# ============================================================================
# 2. Reload udev Rules
# ============================================================================

echo "ğŸ”„ Reloading udev rules..."
if command -v udevadm >/dev/null 2>&1; then
    udevadm control --reload-rules
    udevadm trigger --subsystem-match=usb
    echo "âœ… udev rules reloaded"
else
    echo "âš ï¸  udevadm not found - udev rules will apply after reboot"
fi

# ============================================================================
# 3. Add User to lp Group
# ============================================================================

# Detect current user (works for sudo and non-sudo installs)
CURRENT_USER="${SUDO_USER:-$(whoami)}"

if [ "$CURRENT_USER" != "root" ]; then
    echo "ğŸ‘¤ Adding $CURRENT_USER to 'lp' group..."

    if id -nG "$CURRENT_USER" | grep -qw "lp"; then
        echo "âœ… User already in lp group"
    else
        usermod -a -G lp "$CURRENT_USER"
        echo "âœ… User added to lp group"
        echo "âš ï¸  IMPORTANT: Log out and log back in for group changes to take effect!"
    fi
else
    echo "âš ï¸  Running as root - skipping user group assignment"
    echo "   Run manually: sudo usermod -a -G lp YOUR_USERNAME"
fi

# ============================================================================
# 4. Create Data Directory
# ============================================================================

DATA_DIR="/var/lib/eatsome-printer-service"
if [ ! -d "$DATA_DIR" ]; then
    echo "ğŸ“ Creating data directory..."
    mkdir -p "$DATA_DIR"
    chown "$CURRENT_USER:$CURRENT_USER" "$DATA_DIR" 2>/dev/null || true
    chmod 700 "$DATA_DIR"
    echo "âœ… Data directory created at $DATA_DIR"
fi

# ============================================================================
# 5. Enable and Start systemd User Service
# ============================================================================

if [ "$CURRENT_USER" != "root" ]; then
    echo "ğŸš€ Enabling systemd user service for $CURRENT_USER..."

    # Run as user (not root)
    su - "$CURRENT_USER" -c "systemctl --user daemon-reload"
    su - "$CURRENT_USER" -c "systemctl --user enable eatsome-printer.service"
    su - "$CURRENT_USER" -c "systemctl --user start eatsome-printer.service"

    # Enable lingering (allows service to run without active session)
    loginctl enable-linger "$CURRENT_USER" 2>/dev/null || true

    echo "âœ… Service enabled and started for $CURRENT_USER"
else
    echo "âš ï¸  Running as root - systemd user service not started"
    echo "   Run manually as your user:"
    echo "   systemctl --user enable eatsome-printer.service"
    echo "   systemctl --user start eatsome-printer.service"
fi

# ============================================================================
# 6. Display Post-Install Information
# ============================================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Eatsome Printer Service installed successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ Installation directory: $INSTALL_DIR"
echo "ğŸ“ Service file: $SERVICE_FILE"
echo "ğŸ“ udev rules: $UDEV_RULES"
echo "ğŸ“ Data directory: $DATA_DIR"
echo ""
echo "ğŸ¯ Next Steps:"
echo ""
echo "  1. Log out and log back in (required for lp group membership)"
echo "  2. Connect your USB thermal printer"
echo "  3. Open the Eatsome Printer Service app to configure"
echo ""
echo "ğŸ“– Management commands:"
echo ""
echo "  Check status:  systemctl --user status eatsome-printer.service"
echo "  View logs:     journalctl --user -u eatsome-printer.service -f"
echo "  Restart:       systemctl --user restart eatsome-printer.service"
echo "  Stop:          systemctl --user stop eatsome-printer.service"
echo ""
echo "â“ Need help? Visit: https://github.com/eatsome/eatsome/issues"
echo ""

exit 0
