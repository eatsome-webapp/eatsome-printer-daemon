#!/bin/bash
#
# Debian/Ubuntu (.deb) Post-Removal Script
# Runs after package removal to clean up system configuration
#
# This script:
# 1. Stops and disables systemd user service
# 2. Removes udev rules
# 3. Optionally removes data directory
#

set -e

# Package name
PACKAGE_NAME="eatsome-printer-service"

# Installation paths
UDEV_RULES="/etc/udev/rules.d/60-eatsome-printer.rules"
DATA_DIR="/var/lib/eatsome-printer-service"

# ============================================================================
# 1. Stop and Disable systemd User Service
# ============================================================================

# Detect current user
CURRENT_USER="${SUDO_USER:-$(whoami)}"

if [ "$CURRENT_USER" != "root" ]; then
    echo "â¹ï¸  Stopping systemd user service..."

    # Stop and disable service
    su - "$CURRENT_USER" -c "systemctl --user stop eatsome-printer.service" 2>/dev/null || true
    su - "$CURRENT_USER" -c "systemctl --user disable eatsome-printer.service" 2>/dev/null || true
    su - "$CURRENT_USER" -c "systemctl --user daemon-reload" 2>/dev/null || true

    # Disable lingering
    loginctl disable-linger "$CURRENT_USER" 2>/dev/null || true

    echo "âœ… Service stopped and disabled"
fi

# ============================================================================
# 2. Remove udev Rules
# ============================================================================

if [ -f "$UDEV_RULES" ]; then
    echo "ğŸ—‘ï¸  Removing udev rules..."
    rm -f "$UDEV_RULES"

    # Reload udev
    if command -v udevadm >/dev/null 2>&1; then
        udevadm control --reload-rules
        udevadm trigger --subsystem-match=usb
    fi

    echo "âœ… udev rules removed"
fi

# ============================================================================
# 3. Data Directory Cleanup (on purge only, not on upgrade)
# ============================================================================

# $1 = action (remove, purge, upgrade, etc.)
ACTION="${1:-remove}"

if [ "$ACTION" = "purge" ]; then
    echo "ğŸ—‘ï¸  Purging data directory..."

    if [ -d "$DATA_DIR" ]; then
        rm -rf "$DATA_DIR"
        echo "âœ… Data directory removed"
    fi

    # Also remove user's config directory
    if [ "$CURRENT_USER" != "root" ]; then
        USER_CONFIG="$(eval echo ~$CURRENT_USER)/.config/eatsome-printer-service"
        if [ -d "$USER_CONFIG" ]; then
            rm -rf "$USER_CONFIG"
            echo "âœ… User config removed"
        fi
    fi
else
    echo "ğŸ“ Data directory preserved (use 'apt purge' to remove)"
fi

# ============================================================================
# 4. Display Post-Removal Information
# ============================================================================

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Eatsome Printer Service removed successfully"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [ "$ACTION" != "purge" ]; then
    echo "ğŸ“ Configuration preserved in:"
    echo "   - $DATA_DIR"
    echo "   - ~/.config/eatsome-printer-service"
    echo ""
    echo "ğŸ’¡ To completely remove all data, run:"
    echo "   sudo apt purge $PACKAGE_NAME"
    echo ""
fi

exit 0
